# 근무 시간 관리 달력 - 구조 분석

## 프로젝트 개요

선택적 근로제를 위한 웹 기반 근무 시간 관리 달력 애플리케이션입니다.
- 기본 근무시간: 8시간/일
- 최소 근무시간: 4시간/일
- 최대 근무시간: 13시간/일
- 조정 단위: **1분** (1/60 시간)
- 데이터 가져오기: 인트라넷 근무시간 자동 파싱
- 공휴일 관리: 웹 편집 및 txt 백업/복원

## 파일 구조

```
test_web/
├── index.html          # 메인 HTML 구조
├── style.css           # 스타일시트
├── script.js           # 핵심 로직
├── holidays.txt        # 공휴일 데이터 (CSV 형식)
├── 구조분석.md         # 본 문서
├── 작업히스토리.md     # 개발 히스토리
└── TODO.md             # 향후 개선사항
```

## 핵심 기능 구조

### 1. 데이터 구조 (localStorage)

```javascript
{
  "2025-12": {
    "2025-12-23": {
      hours: 11,
      manual: true,      // 수동 조정 여부
      vacation: false    // 휴가 여부
    },
    "2025-12-24": {
      hours: 7.5,
      manual: false,     // 자동 조정된 시간
      vacation: false
    },
    "2025-12-25": {
      hours: 8,
      manual: false,
      vacation: true     // 휴가로 체크됨
    }
  }
}
```

**저장 함수:**
- `saveHours(date, hours, isManual, clearVacation)` - 시간 저장
- `loadHours(date)` - 시간 불러오기
- `isManuallyModified(date)` - 수동 수정 여부 확인
- `isVacation(date)` - 휴가 여부 확인
- `toggleVacation(date)` - 휴가 토글

### 2. UI 컴포넌트

#### 2.1 달력 그리드
- 7열 그리드 레이아웃 (일~토)
- 요일 헤더 + 날짜 셀
- 주말/공휴일 시각적 구분

#### 2.2 날짜 셀 구조
```html
<div class="day-cell [weekend|holiday|vacation|today|other-month]">
  <div class="day-number">
    <input type="checkbox" class="exclude-checkbox">  <!-- 평일만 -->
    <span>23</span>
    <span class="lock-icon locked">🔒</span>  <!-- 수동 조정 시 -->
  </div>

  <!-- 휴가일 경우 -->
  <div class="excluded-label">제외됨</div>

  <!-- 평일 + 비휴가일 경우 -->
  <div class="hours-control">
    <div class="hours-bar-container">
      <div class="hours-bar [low|normal|high|extreme]">
        <div class="hours-display">8h 30m</div>
      </div>
    </div>
  </div>
</div>
```

**특수 상태:**
- `other-month`: 이전/다음 달 날짜 (opacity: 0.3)
- `vacation`: 휴가일 (노란색 배경, 계산 제외)

#### 2.3 수직 바 컴포넌트
- **위치**: 날짜 셀 하단
- **높이**: 근무시간에 비례 (4h=15%, 13h=100%)
- **색상**: 4단계 구분
  - 🔵 파란색 (low): ≤ 4h
  - 🟢 초록색 (normal): 4h ~ 8h
  - 🟠 주황색 (high): 8h ~ 10h
  - 🔴 붉은색 (extreme): > 10h
- **인터랙션**: 클릭/드래그로 시간 조정

### 3. 자동 조정 시스템

#### 3.1 로직 흐름
```
1. 사용자가 날짜의 시간 조정
   ↓
2. 해당 날짜를 수동 조정으로 마킹 (manual: true)
   ↓
3. autoAdjustFutureWeekdays() 실행
   ↓
4. 오늘까지의 실제 근무시간 계산
   ↓
5. 미래 평일 중 수동 조정되지 않은 날짜 찾기
   (주말, 공휴일, 휴가일 제외)
   ↓
6. 부족/초과 시간을 해당 날짜들에 균등 분배
   ↓
7. DOM 업데이트 (재렌더링 없이)
```

#### 3.2 핵심 함수
```javascript
autoAdjustFutureWeekdays() {
  // 1. 오늘까지의 근무시간 집계
  // 2. 미래 날짜 분류:
  //    - 주말/공휴일/휴가 → 제외
  //    - manual: true → 고정 (제외)
  //    - manual: false → 자동 조정 대상
  // 3. 필요 시간 계산 및 분배
}
```

### 4. 공휴일 시스템

#### 4.1 데이터 구조 (localStorage 기반)

**기본 공휴일 데이터**:
```javascript
const defaultHolidays = [
  { date: '2024-01-01', name: '신정' },
  { date: '2024-02-10', name: '설날' },
  { date: '2025-01-01', name: '신정' },
  // ... 2024-2027년 공휴일 67개
];
```

**실행 중 데이터**:
```javascript
let koreanHolidays = loadHolidays(); // localStorage에서 로드
```

**localStorage 키**: `koreanHolidays`
**데이터 형식**: JSON 배열

#### 4.2 데이터 관리 함수

```javascript
// localStorage에서 공휴일 로드 (없으면 기본값 사용)
function loadHolidays() {
    const stored = localStorage.getItem('koreanHolidays');
    if (stored) {
        return JSON.parse(stored);
    }
    return defaultHolidays;
}

// localStorage에 공휴일 저장
function saveHolidaysData(holidays) {
    localStorage.setItem('koreanHolidays', JSON.stringify(holidays));
}

// 초기화 (첫 실행 시 기본값 저장)
function initializeHolidays() {
    const stored = localStorage.getItem('koreanHolidays');
    if (!stored) {
        saveHolidaysData(defaultHolidays);
    }
    return loadHolidays();
}
```

#### 4.3 공휴일 확인 함수

```javascript
function isHoliday(date) {
    const dateStr = formatDate(date);
    const holiday = koreanHolidays.find(h => h.date === dateStr);
    return holiday ? holiday.name : null;
}
```

#### 4.4 공휴일 처리
- 주말과 동일하게 근무시간 입력 불가
- 분홍색 배경으로 시각적 구분
- 필요 근무시간 계산에서 제외
- 사용자가 웹에서 추가/수정/삭제 가능

#### 4.5 holidays.txt 파일

**형식**: CSV (YYYY-MM-DD,이름)
```
2024-01-01,신정
2024-02-09,설날 연휴
2024-02-10,설날
...
```

**용도**:
- 초기 공휴일 데이터 참조
- 백업 및 복원
- 다른 사용자와 공유

### 5. 잠금/해제 시스템

#### 5.1 수동 잠금
- 사용자가 시간 조정 → 자동으로 🔒 표시
- 잠금된 날짜는 자동 조정 대상에서 제외

#### 5.2 잠금 해제
- 🔒 아이콘 클릭 → 잠금 해제
- 즉시 자동 조정 시스템에 포함
- 아이콘 제거

#### 5.3 관련 함수
```javascript
addLockIcon(date)        // 잠금 아이콘 추가
removeLockIcon(date)     // 잠금 아이콘 제거
toggleManualLock(date)   // 잠금 토글
```

## 주요 알고리즘

### 1. 바 높이 계산

```javascript
// 4h = 15%, 13h = 100%
heightPercent = 15 + ((hours - 4) / (13 - 4)) * 85

예시:
- 4h  → 15%
- 8h  → 52.22%
- 13h → 100%
```

### 2. 클릭 위치 → 시간 변환

```javascript
// 클릭 Y좌표 → 백분율 → 시간
clickPercent = ((containerHeight - clickY) / containerHeight) * 100
hours = 4 + ((clickPercent - 15) / 85) * 9
```

### 3. 시간 반올림 (1분 단위)

```javascript
// 1분 = 1/60 시간
roundedHours = Math.round(hours * 60) / 60

예시:
- 8.123h → 8.133h (8시간 8분)
- 8.456h → 8.450h (8시간 27분)
- 8.789h → 8.783h (8시간 47분)
```

## 요약 패널

### 계산 로직

```javascript
// 주말, 공휴일, 휴가일 제외
총 필요 근무시간 = (평일 수 - 휴가일 수) × 8h
실제 근무시간 = Σ(각 날짜의 근무시간)  // 휴가일 제외
현재까지 근무 시간 = Σ(어제까지의 근무시간)  // 오늘 제외
부족/초과 = 실제 - 필요
남은 평일 평균 = (필요 - 현재까지) / 남은 평일 수  // 오늘 포함
```

### 표시 형식
- 이번 달 필요 근무시간: `160h`
- 실제 근무시간: `160h 10m`
- 현재까지 근무 시간: `121h 50m` (어제까지)
- 부족/초과: `+0h 10m` (초록색) 또는 `-4h 30m` (빨간색)
- 남은 평일 평균 필요 시간: `7h 38m/일`

## 성능 최적화

### 1. 재렌더링 최소화
- 바 조정 시 전체 달력 재렌더링 하지 않음
- DOM 쿼리로 해당 요소만 직접 업데이트
- 잠금 아이콘도 동적 추가/제거

### 2. 이벤트 처리
- 드래그 중 mousemove 이벤트는 document 레벨에서 처리
- mouseup으로 드래그 종료 감지
- 불필요한 이벤트 리스너 중복 방지

### 3. 데이터 구조
- 월별로 데이터 분리 저장
- 불필요한 데이터 로드 방지
- localStorage 효율적 활용

## 브라우저 호환성

- localStorage 사용 (IE 8+)
- CSS Grid 사용 (IE 10+ with prefix)
- ES6 기능 사용 (모던 브라우저)
- 권장: Chrome, Firefox, Safari, Edge (최신 버전)

## 주요 CSS 클래스

```css
.day-cell              # 날짜 셀
  .weekend             # 주말 (회색 배경)
  .holiday             # 공휴일 (분홍 배경)
  .vacation            # 휴가 (노란 배경)
  .today               # 오늘 (파란 테두리)
  .other-month         # 이전/다음 달 (흐리게)

.hours-bar             # 근무시간 바
  .low                 # ≤ 4h (파란색)
  .normal              # 4-8h (초록색)
  .high                # 8-10h (주황색)
  .extreme             # > 10h (빨간색)

.lock-icon             # 잠금 아이콘
  .locked              # 잠금 상태 (🔒)

.exclude-checkbox      # 제외 체크박스 (평일만)
.excluded-label        # "제외됨" 레이블

.modal                 # 모달 (데이터 가져오기, 공휴일 관리)
.modal-content         # 모달 컨텐츠

.manage-holidays-button  # 공휴일 관리 버튼 (파란색)
#holidayTextarea       # 공휴일 편집 텍스트 영역
```

## 데이터 흐름

### 수동 시간 조정
```
사용자 입력
    ↓
saveHours(date, hours, manual: true)
    ↓
localStorage 저장
    ↓
addLockIcon(date)
    ↓
autoAdjustFutureWeekdays()
    ↓
미래 날짜 자동 조정
    ↓
DOM 업데이트 (해당 날짜 바만)
    ↓
updateSummary()
    ↓
요약 패널 갱신
```

### 휴가 체크박스 클릭
```
체크박스 클릭
    ↓
toggleVacation(date)
    ↓
vacation 플래그 토글
    ↓
localStorage 저장
    ↓
renderCalendar() (전체 재렌더링)
    ↓
요약 패널 갱신
```

### 공휴일 관리
```
"공휴일 관리" 버튼 클릭
    ↓
openHolidayModal()
    ↓
loadHolidays() (localStorage)
    ↓
CSV 형식으로 변환
    ↓
textarea에 표시
    ↓
사용자 편집 (또는 txt 가져오기)
    ↓
"저장" 버튼 클릭
    ↓
saveHolidaysFromTextarea()
    ↓
CSV 파싱 및 유효성 검사
    ↓
날짜순 정렬
    ↓
koreanHolidays 전역 변수 업데이트
    ↓
saveHolidaysData() → localStorage
    ↓
renderCalendar() (전체 재렌더링)
    ↓
새 공휴일 즉시 반영
```

## 추가 기능

### 1. 휴가 관리 시스템

#### 1.1 휴가 체크박스
- 평일에만 표시 (주말/공휴일 제외)
- 체크 시 vacation: true로 설정
- 노란색 배경 + "제외됨" 레이블

#### 1.2 휴가일 처리
- 근무시간 바 숨김
- 계산에서 완전히 제외
- 자동 조정 대상에서 제외
- 주말/공휴일과 동일한 처리

### 2. 달력 렌더링 시스템

#### 2.1 이전/다음 달 날짜 표시
```javascript
// 달력 채우기
이전 달 날짜 (월 시작 전)
    ↓
현재 달 날짜
    ↓
다음 달 날짜 (5줄/6줄까지 채우기)
```

#### 2.2 자동 줄 수 계산
```javascript
currentCells = startingDayOfWeek + 해당 달 일수
if (currentCells <= 35) {
    totalCells = 35  // 5줄
} else {
    totalCells = 42  // 6줄
}
```

#### 2.3 다른 달 날짜 스타일
- `other-month` 클래스 추가
- opacity: 0.3 (흐리게)
- 체크박스, 잠금 아이콘, 근무시간 바 없음

### 3. 데이터 가져오기 시스템

#### 3.1 UI 구성
```html
<button id="importData">데이터 넣기</button>

<div id="importModal" class="modal">
  <div class="modal-content">
    <h2>인트라넷 데이터 가져오기</h2>
    <textarea id="importTextarea"></textarea>
    <button id="parseData">적용하기</button>
  </div>
</div>
```

#### 3.2 파싱 프로세스
```
1. 텍스트 데이터 입력
   ↓
2. 줄 단위 분리 및 수정 내역 필터링
   ↓
3. 날짜별 데이터 그룹화
   ├─ 업무 시간 누적
   └─ 휴게 시간 누적
   ↓
4. 실제 근무시간 계산 (업무 - 휴게)
   ↓
5. localStorage 저장 (clearVacation: true)
   ↓
6. 빠진 날짜 자동 휴가 설정
   ├─ 가장 이른 날짜 ~ 오늘
   ├─ 데이터 없는 평일 찾기
   └─ vacation: true 설정
   ↓
7. 달력 재렌더링
```

#### 3.3 파싱 로직

**지원 형식:**
```
날짜         구분    시간                      ...
2025-12-23   업무    09:27 ~ 16:30 (07:03)    ...
2025-12-23   휴게    12:00 ~ 12:30 (00:30)    ...
```

**파싱 규칙:**
1. 첫 번째 필드가 정확히 `YYYY-MM-DD` 형식인 경우만 날짜로 인식
2. 수정 내역 줄 건너뛰기:
   - `*`로 시작
   - `사유:`로 시작
   - `시간 수정`, `시간 추가`, `시작 시간:`, `종료 시간:` 포함
3. "업무" / "휴게" 구분
4. 괄호 안의 시간 추출: `(HH:MM)`
5. 시:분을 decimal hours로 변환

**계산:**
```javascript
실제 근무시간 = Σ업무시간 - Σ휴게시간

예시:
업무: 09:00 ~ 18:00 (09:00) = 9.0h
휴게: 12:00 ~ 12:30 (00:30) = 0.5h
휴게: 15:00 ~ 15:15 (00:15) = 0.25h
────────────────────────────────
실제: 9.0 - 0.5 - 0.25 = 8.25h
```

#### 3.4 자동 휴가 설정
```javascript
// 빠진 날짜 찾기
for (날짜 = 최초날짜; 날짜 < 오늘; 날짜++) {
  if (!importedDates.has(날짜) && 평일) {
    vacation: true 설정
  }
}
```

### 4. 공휴일 관리 시스템

#### 4.1 UI 구성

**버튼**:
```html
<button id="manageHolidays" class="manage-holidays-button">공휴일 관리</button>
```
- 위치: footer (이번 달로 돌아가기 / 데이터 넣기 사이)
- 색상: 파란색 (#667eea)

**모달**:
```html
<div id="holidayModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>공휴일 관리</h2>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <p>한 줄에 하나씩 입력하세요 (형식: YYYY-MM-DD,이름)</p>
      <textarea id="holidayTextarea" placeholder="2025-01-01,신정..."></textarea>
      <div class="modal-actions">
        <button id="saveHolidays">저장</button>
        <button id="exportHolidays">txt로 내보내기</button>
        <button id="importHolidays">txt에서 가져오기</button>
        <button id="cancelHoliday">취소</button>
      </div>
      <input type="file" id="holidayFileInput" accept=".txt" style="display: none">
    </div>
  </div>
</div>
```

#### 4.2 주요 기능

**1. 모달 열기**:
```javascript
function openHolidayModal() {
    // 현재 공휴일을 CSV 형식으로 변환
    const text = koreanHolidays
        .map(h => `${h.date},${h.name}`)
        .join('\n');
    textarea.value = text;
    modal.style.display = 'block';
}
```

**2. 저장 (텍스트 → localStorage)**:
```javascript
function saveHolidaysFromTextarea() {
    // 1. 줄 단위 분리
    const lines = textarea.value.split('\n').filter(line => line.trim());

    // 2. CSV 파싱
    const holidays = [];
    for (const line of lines) {
        const parts = line.split(',');
        const date = parts[0].trim();
        const name = parts.slice(1).join(',').trim(); // 쉼표 포함 이름 지원

        if (date && name && /^\d{4}-\d{2}-\d{2}$/.test(date)) {
            holidays.push({ date, name });
        }
    }

    // 3. 날짜순 정렬
    holidays.sort((a, b) => a.date.localeCompare(b.date));

    // 4. 전역 변수 및 localStorage 저장
    koreanHolidays = holidays;
    saveHolidaysData(holidays);

    // 5. 달력 재렌더링
    closeHolidayModal();
    renderCalendar(currentYear, currentMonth);

    alert(`${holidays.length}개의 공휴일이 저장되었습니다.`);
}
```

**3. txt로 내보내기**:
```javascript
function exportHolidaysToFile() {
    // CSV 텍스트 생성
    const text = koreanHolidays
        .map(h => `${h.date},${h.name}`)
        .join('\n');

    // Blob 생성 및 다운로드
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'holidays.txt';
    a.click();
    URL.revokeObjectURL(url);
}
```

**4. txt에서 가져오기**:
```javascript
function importHolidaysFromFile() {
    // 파일 선택 대화상자 열기
    const input = document.getElementById('holidayFileInput');
    input.click();
}

function handleHolidayFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // FileReader로 파일 읽기
    const reader = new FileReader();
    reader.onload = (e) => {
        const text = e.target.result;
        // textarea에 로드 (사용자가 확인 후 "저장" 클릭)
        document.getElementById('holidayTextarea').value = text;
    };
    reader.readAsText(file, 'UTF-8');

    // 입력 초기화
    event.target.value = '';
}
```

#### 4.3 데이터 흐름

```
사용자 액션
    ↓
┌─────────────────────────────────────┐
│ 1. "공휴일 관리" 버튼 클릭          │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 2. openHolidayModal()               │
│    - localStorage에서 로드          │
│    - CSV 형식으로 변환              │
│    - textarea에 표시                │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 3. 사용자 편집                      │
│    - 직접 수정/추가/삭제            │
│    - 또는 "txt에서 가져오기"        │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 4. "저장" 버튼 클릭                 │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 5. saveHolidaysFromTextarea()       │
│    - CSV 파싱                       │
│    - 유효성 검사                    │
│    - 날짜순 정렬                    │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 6. localStorage 저장                │
│    - koreanHolidays 업데이트        │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 7. 달력 재렌더링                    │
│    - 새 공휴일 즉시 반영            │
└─────────────────────────────────────┘
```

#### 4.4 파싱 로직 상세

**쉼표 처리**:
```javascript
// "2025-12-25,크리스마스,성탄절" 같은 경우
const parts = line.split(',');
const date = parts[0].trim();           // "2025-12-25"
const name = parts.slice(1).join(',').trim();  // "크리스마스,성탄절"
```

**유효성 검사**:
- 날짜 형식: `/^\d{4}-\d{2}-\d{2}$/` (YYYY-MM-DD)
- 날짜와 이름 모두 존재해야 함
- 빈 줄은 자동으로 무시

**정렬**:
```javascript
holidays.sort((a, b) => a.date.localeCompare(b.date));
// "2024-01-01"이 "2025-12-31"보다 앞에 옴
```

#### 4.5 사용 사례

**사례 1: 회사 공휴일 추가**
1. "공휴일 관리" 클릭
2. 마지막 줄에 추가: `2025-08-20,회사 창립기념일`
3. "저장" 클릭
4. → 달력에서 8월 20일이 공휴일로 표시됨

**사례 2: 공휴일 백업**
1. "공휴일 관리" 클릭
2. "txt로 내보내기" 클릭
3. → `holidays.txt` 파일 다운로드
4. 안전한 곳에 보관

**사례 3: 공휴일 복원**
1. "공휴일 관리" 클릭
2. "txt에서 가져오기" 클릭
3. 백업한 `holidays.txt` 선택
4. textarea에 자동으로 로드됨 (확인 가능)
5. "저장" 클릭
6. → 백업된 공휴일 복원 완료

**사례 4: 공휴일 삭제**
1. "공휴일 관리" 클릭
2. 해당 줄 전체 삭제
3. "저장" 클릭
4. → 달력에서 해당 날짜가 평일로 변경

#### 4.6 CSS 스타일

**버튼**:
```css
.manage-holidays-button {
    padding: 12px 25px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
}

.manage-holidays-button:hover {
    background: #5568d3;
}
```

**텍스트 영역**:
```css
#holidayTextarea {
    width: 100%;
    min-height: 400px;
    padding: 12px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    resize: vertical;
    line-height: 1.5;
}

#holidayTextarea:focus {
    outline: none;
    border-color: #667eea;
}
```

## 핵심 특징 요약

### 1. 정밀도
- **1분 단위** 시간 조정
- 정확한 시분 표시 (8h 27m)

### 2. 자동화
- 미래 날짜 자동 조정
- 인트라넷 데이터 자동 파싱
- 빠진 날짜 자동 휴가 설정

### 3. 유연성
- 수동 잠금/해제
- 휴가 관리 (체크박스)
- 이전/다음 달 날짜 표시
- 공휴일 사용자 정의 (추가/수정/삭제)

### 4. 정확성
- 휴게 시간 자동 차감
- 주말/공휴일/휴가 자동 제외
- 어제까지의 실적 기반 평균 계산

### 5. 사용성
- 클릭/드래그 직관적 조작
- 실시간 요약 통계
- 모달 기반 데이터 가져오기
- 웹 기반 공휴일 편집 (txt 백업/복원)
